---
**Status:** To Do
**Priority:** P4 (Medium)
**Branch:** `feature/P4.3-csv-preview`
---

## Overview

Implement a preview mechanism for CSV files using a slide-over sheet component. Fetches partial file content and parses with Papaparse.

---

## Requirements

- Endpoint: `GET /api/s3/preview?key=...` (streams first N bytes)
- Frontend: Use `papaparse` to parse the chunk
- Display first 50 rows in a data table
- Use shadcn/ui Sheet component for slide-over UI

---

## Implementation Steps

### Commit 1: `feat: Create /api/s3/preview endpoint`

File: `app/api/s3/preview/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { GetObjectCommand } from '@aws-sdk/client-s3';
import { s3Client, BUCKET_NAME } from '@/lib/s3';

export async function GET(request: NextRequest) {
  const key = request.nextUrl.searchParams.get('key');

  if (!key) {
    return NextResponse.json({ error: 'Key required' }, { status: 400 });
  }

  try {
    const command = new GetObjectCommand({
      Bucket: BUCKET_NAME,
      Key: key,
      Range: 'bytes=0-102400', // First 100KB
    });

    const response = await s3Client.send(command);
    const content = await response.Body?.transformToString();

    return NextResponse.json({ content });
  } catch (error) {
    console.error('Preview error:', error);
    return NextResponse.json(
      { error: 'Failed to fetch preview' },
      { status: 500 }
    );
  }
}
```

### Commit 2: `feat: Create CSVPreviewSheet component`

```typescript
// components/csv-preview-sheet.tsx
'use client';

import { Sheet, SheetContent, SheetHeader, SheetTitle } from '@/components/ui/sheet';
import { useQuery } from '@tanstack/react-query';
import Papa from 'papaparse';

interface CSVPreviewSheetProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  fileKey: string;
}

export function CSVPreviewSheet({ open, onOpenChange, fileKey }: CSVPreviewSheetProps) {
  const { data } = useQuery({
    queryKey: ['preview', fileKey],
    queryFn: async () => {
      const res = await fetch(`/api/s3/preview?key=${encodeURIComponent(fileKey)}`);
      const { content } = await res.json();
      return Papa.parse(content, { header: true, preview: 50 });
    },
    enabled: open,
  });

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent side="right" className="w-[80vw] sm:max-w-[80vw]">
        <SheetHeader>
          <SheetTitle>{fileKey.split('/').pop()}</SheetTitle>
        </SheetHeader>
        {/* Render data table here */}
      </SheetContent>
    </Sheet>
  );
}
```

---

## Acceptance Criteria

- [ ] Clicking a CSV file opens the preview sheet
- [ ] Data is fetched and parsed correctly
- [ ] Preview shows first 50 rows in a table
- [ ] Column headers are displayed
- [ ] Loading state shown while fetching

---

## Dependencies

- P1.2 Install shadcn/ui
- P2.1 S3 Client
- P2.4 File Grid

## Blocking

- None (end of feature chain)
