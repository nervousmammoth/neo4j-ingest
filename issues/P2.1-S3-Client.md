---
**Status:** To Do
**Priority:** P2 (High)
**Branch:** `feature/P2.1-s3-client`
---

## Overview

Create a singleton instance of the AWS S3 Client to be used across API routes. The client must support both MinIO (development) and VMware Aria S3 (production).

---

## User Stories

**As a** developer
**I want** a singleton S3 client that works with both MinIO and VMware Aria S3
**So that** all API routes can communicate with S3 storage without code duplication or memory leaks

**As a** developer
**I want** the S3 client to automatically configure itself based on environment variables
**So that** the same code works in development and production without changes

---

## Requirements

- Use `@aws-sdk/client-s3` v3
- Configure with region and credentials from environment variables
- Ensure only one instance is created in development (to avoid hot-reload memory leaks)
- Support conditional endpoint configuration for MinIO vs production S3

---

## Implementation Steps

### Commit 1: `feat: Create S3 client singleton`

File: `lib/s3.ts`

```typescript
import { S3Client } from '@aws-sdk/client-s3';

const globalForS3 = globalThis as unknown as { s3Client: S3Client };

export const s3Client = globalForS3.s3Client ?? new S3Client({
  region: process.env.AWS_REGION || 'us-east-1',
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,
  },
  ...(process.env.AWS_ENDPOINT_URL && {
    endpoint: process.env.AWS_ENDPOINT_URL,
    forcePathStyle: process.env.S3_FORCE_PATH_STYLE === 'true',
  }),
});

if (process.env.NODE_ENV !== 'production') {
  globalForS3.s3Client = s3Client;
}

export const BUCKET_NAME = process.env.S3_BUCKET_NAME!;
```

### Commit 2: `test: Add S3 connectivity test`

Verify connection to MinIO/S3 with a simple `ListBuckets` command.

---

## Acceptance Criteria

- [ ] S3 Client is exported from `lib/s3.ts`
- [ ] Singleton pattern prevents memory leaks during hot reload
- [ ] Client connects to MinIO in development
- [ ] Basic connectivity test (can list buckets or similar) passes

---

## Dependencies

- P1.1 Init Project
- P1.3 Docker Setup (for MinIO)

## Blocking

- P2.2 List Endpoint
- P3.2 Sign Endpoint
- P4.1 Rename API
