---
**Status:** To Do
**Priority:** P3 (High)
**Branch:** `feature/P3.2-sign-endpoint`
---

## Overview

Implement the backend endpoint to generate presigned URLs for Uppy direct-to-S3 uploads. Supports both single PUT and multipart uploads.

---

## User Stories

**As a** developer
**I want** to generate presigned S3 URLs on the server
**So that** users can upload files directly to S3 without exposing AWS credentials to the browser

**As a** developer
**I want** to sanitize filenames before generating presigned URLs
**So that** special characters and emojis don't cause S3 key encoding issues

---

## Requirements

- Endpoint: `POST /api/s3/sign`
- Use `@aws-sdk/s3-request-presigner` for presigned URL generation
- Validate input with Zod
- Support multipart upload initialization

---

## Implementation Steps

### Commit 1: `feat: Create /api/s3/sign endpoint`

File: `app/api/s3/sign/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { PutObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';
import { z } from 'zod';
import { s3Client, BUCKET_NAME } from '@/lib/s3';

const signSchema = z.object({
  filename: z.string().min(1),
  contentType: z.string().min(1),
  prefix: z.string().optional().default(''),
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { filename, contentType, prefix } = signSchema.parse(body);

    // Sanitize filename
    const sanitizedFilename = filename.replace(/[^a-zA-Z0-9._-]/g, '_');
    const key = `${prefix}${sanitizedFilename}`;

    const command = new PutObjectCommand({
      Bucket: BUCKET_NAME,
      Key: key,
      ContentType: contentType,
    });

    const url = await getSignedUrl(s3Client, command, { expiresIn: 3600 });

    return NextResponse.json({
      method: 'PUT',
      url,
      fields: {},
      headers: { 'Content-Type': contentType },
    });
  } catch (error) {
    console.error('Sign error:', error);
    return NextResponse.json(
      { error: 'Failed to generate presigned URL' },
      { status: 500 }
    );
  }
}
```

### Commit 2: `feat: Add multipart upload support`

Add endpoints for `createMultipartUpload`, `signPart`, and `completeMultipartUpload`.

---

## Acceptance Criteria

- [ ] Endpoint returns a valid presigned URL
- [ ] Uppy can successfully request a signature
- [ ] Input is validated (filename, contentType)
- [ ] Filenames are sanitized (no special chars/emojis)

---

## Dependencies

- P2.1 S3 Client

## Blocking

- P3.3 Drag-Drop Integration
