---
**Status:** To Do
**Priority:** P4 (Medium)
**Branch:** `feature/P4.1-rename-api`
---

## Overview

Create the backend logic for renaming/moving files in S3. Since S3 is immutable, this requires Copy + Delete operations.

---

## Requirements

- Endpoint: `POST /api/s3/rename`
- Body: `{ sourceKey, destinationKey }`
- Execute `CopyObject` then `DeleteObject`
- Handle errors (if copy fails, don't delete original)
- Support both files and folders (recursive for folders)

---

## Implementation Steps

### Commit 1: `feat: Create /api/s3/rename endpoint`

File: `app/api/s3/rename/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { CopyObjectCommand, DeleteObjectCommand } from '@aws-sdk/client-s3';
import { z } from 'zod';
import { s3Client, BUCKET_NAME } from '@/lib/s3';

const renameSchema = z.object({
  sourceKey: z.string().min(1),
  destinationKey: z.string().min(1),
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { sourceKey, destinationKey } = renameSchema.parse(body);

    // Copy to new location
    await s3Client.send(new CopyObjectCommand({
      Bucket: BUCKET_NAME,
      CopySource: `${BUCKET_NAME}/${sourceKey}`,
      Key: destinationKey,
    }));

    // Delete original only after successful copy
    await s3Client.send(new DeleteObjectCommand({
      Bucket: BUCKET_NAME,
      Key: sourceKey,
    }));

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Rename error:', error);
    return NextResponse.json(
      { error: 'Failed to rename object' },
      { status: 500 }
    );
  }
}
```

### Commit 2: `feat: Add /api/s3/delete endpoint`

Support single and batch delete operations.

---

## Acceptance Criteria

- [ ] Renaming a file results in new key existing and old key removed
- [ ] Metadata is preserved during copy
- [ ] Error handling prevents data loss (no delete if copy fails)
- [ ] Delete endpoint works for single and batch operations

---

## Dependencies

- P2.1 S3 Client

## Blocking

- P4.2 Context Menu
