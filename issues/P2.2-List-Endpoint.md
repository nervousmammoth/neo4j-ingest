---
**Status:** To Do
**Priority:** P2 (High)
**Branch:** `feature/P2.2-list-endpoint`
---

## Overview

Develop the API route to list objects in the S3 bucket with support for virtual folder navigation using S3 prefix and delimiter patterns.

---

## Requirements

- Endpoint: `GET /api/s3/list`
- Query Params: `prefix` (for folder navigation)
- Use `Delimiter` to support folder structure (virtual folders)
- Return JSON structure compatible with the frontend tree/grid

---

## Implementation Steps

### Commit 1: `feat: Create /api/s3/list endpoint`

File: `app/api/s3/list/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { ListObjectsV2Command } from '@aws-sdk/client-s3';
import { s3Client, BUCKET_NAME } from '@/lib/s3';

export async function GET(request: NextRequest) {
  const prefix = request.nextUrl.searchParams.get('prefix') || '';

  try {
    const command = new ListObjectsV2Command({
      Bucket: BUCKET_NAME,
      Prefix: prefix,
      Delimiter: '/',
    });

    const response = await s3Client.send(command);

    const folders = (response.CommonPrefixes || []).map((p) => ({
      name: p.Prefix?.replace(prefix, '').replace('/', ''),
      key: p.Prefix,
      type: 'folder' as const,
    }));

    const files = (response.Contents || [])
      .filter((obj) => obj.Key !== prefix)
      .map((obj) => ({
        name: obj.Key?.replace(prefix, ''),
        key: obj.Key,
        size: obj.Size,
        lastModified: obj.LastModified,
        type: 'file' as const,
      }));

    return NextResponse.json({ folders, files });
  } catch (error) {
    console.error('S3 list error:', error);
    return NextResponse.json(
      { error: 'Failed to list objects' },
      { status: 500 }
    );
  }
}
```

---

## API Contract

**GET /api/s3/list?prefix=data/**

Success Response (200):
```json
{
  "folders": [
    { "name": "reports", "key": "data/reports/", "type": "folder" }
  ],
  "files": [
    {
      "name": "sample.csv",
      "key": "data/sample.csv",
      "size": 1024,
      "lastModified": "2024-01-01T00:00:00Z",
      "type": "file"
    }
  ]
}
```

---

## Acceptance Criteria

- [ ] API returns list of files and "folders" (prefixes) for a given prefix
- [ ] Handles empty buckets gracefully
- [ ] Error handling for S3 connectivity issues
- [ ] Response structure matches API contract

---

## Dependencies

- P2.1 S3 Client

## Blocking

- P2.3 Sidebar Tree
- P2.4 File Grid
